{"version":3,"file":"sentry-nest-event-instrumentation.js","sources":["../../../../../src/integrations/tracing/nest/sentry-nest-event-instrumentation.ts"],"sourcesContent":["import { isWrapped } from '@opentelemetry/core';\nimport type { InstrumentationConfig } from '@opentelemetry/instrumentation';\nimport {\n  InstrumentationBase,\n  InstrumentationNodeModuleDefinition,\n  InstrumentationNodeModuleFile,\n} from '@opentelemetry/instrumentation';\nimport { SDK_VERSION, captureException, startSpan } from '@sentry/core';\nimport { getEventSpanOptions } from './helpers';\nimport type { OnEventTarget } from './types';\n\nconst supportedVersions = ['>=2.0.0'];\n\n/**\n * Custom instrumentation for nestjs event-emitter\n *\n * This hooks into the `OnEvent` decorator, which is applied on event handlers.\n */\nexport class SentryNestEventInstrumentation extends InstrumentationBase {\n  public static readonly COMPONENT = '@nestjs/event-emitter';\n  public static readonly COMMON_ATTRIBUTES = {\n    component: SentryNestEventInstrumentation.COMPONENT,\n  };\n\n  public constructor(config: InstrumentationConfig = {}) {\n    super('sentry-nestjs-event', SDK_VERSION, config);\n  }\n\n  /**\n   * Initializes the instrumentation by defining the modules to be patched.\n   */\n  public init(): InstrumentationNodeModuleDefinition {\n    const moduleDef = new InstrumentationNodeModuleDefinition(\n      SentryNestEventInstrumentation.COMPONENT,\n      supportedVersions,\n    );\n\n    moduleDef.files.push(this._getOnEventFileInstrumentation(supportedVersions));\n    return moduleDef;\n  }\n\n  /**\n   * Wraps the @OnEvent decorator.\n   */\n  private _getOnEventFileInstrumentation(versions: string[]): InstrumentationNodeModuleFile {\n    return new InstrumentationNodeModuleFile(\n      '@nestjs/event-emitter/dist/decorators/on-event.decorator.js',\n      versions,\n      (moduleExports: { OnEvent: OnEventTarget }) => {\n        if (isWrapped(moduleExports.OnEvent)) {\n          this._unwrap(moduleExports, 'OnEvent');\n        }\n        this._wrap(moduleExports, 'OnEvent', this._createWrapOnEvent());\n        return moduleExports;\n      },\n      (moduleExports: { OnEvent: OnEventTarget }) => {\n        this._unwrap(moduleExports, 'OnEvent');\n      },\n    );\n  }\n\n  /**\n   * Creates a wrapper function for the @OnEvent decorator.\n   */\n  private _createWrapOnEvent() {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    return function wrapOnEvent(original: any) {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      return function wrappedOnEvent(event: any, options?: any) {\n        const eventName = Array.isArray(event)\n          ? event.join(',')\n          : typeof event === 'string' || typeof event === 'symbol'\n            ? event.toString()\n            : '<unknown_event>';\n\n        // Get the original decorator result\n        const decoratorResult = original(event, options);\n\n        // Return a new decorator function that wraps the handler\n        return function (target: OnEventTarget, propertyKey: string | symbol, descriptor: PropertyDescriptor) {\n          if (!descriptor.value || typeof descriptor.value !== 'function' || target.__SENTRY_INTERNAL__) {\n            return decoratorResult(target, propertyKey, descriptor);\n          }\n\n          // Get the original handler\n          const originalHandler = descriptor.value;\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n          const handlerName = originalHandler.name || propertyKey;\n\n          // Instrument the handler\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          descriptor.value = async function (...args: any[]) {\n            return startSpan(getEventSpanOptions(eventName), async () => {\n              try {\n                // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n                const result = await originalHandler.apply(this, args);\n                return result;\n              } catch (error) {\n                // exceptions from event handlers are not caught by global error filter\n                captureException(error);\n                throw error;\n              }\n            });\n          };\n\n          // Preserve the original function name\n          Object.defineProperty(descriptor.value, 'name', {\n            value: handlerName,\n            configurable: true,\n          });\n\n          // Apply the original decorator\n          return decoratorResult(target, propertyKey, descriptor);\n        };\n      };\n    };\n  }\n}\n"],"names":["InstrumentationBase","SDK_VERSION","InstrumentationNodeModuleDefinition","InstrumentationNodeModuleFile","isWrapped","startSpan","getEventSpanOptions","captureException"],"mappings":"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"}